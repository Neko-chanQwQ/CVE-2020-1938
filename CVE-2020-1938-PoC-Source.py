import requests
import re
import nmap
from lxml import etree


def address():
    ipaddr = input("Input IP Address(default port is 8080):")
    return ipaddr


def geturl(ipaddr):
    result = "http://" + ipaddr + ":8080"
    return result


def version(ipaddr):
    res = requests.get(url=ipaddr).text
    result = etree.HTML(res)
    ver = str(result.xpath('//title/text()'))
    #print(ver)
    num = re.findall(r"\d+", ver)
    #print(num)
    return num


def port(host):
    nm = nmap.PortScanner()
    nm.scan(host, '8009')
    status = nm[host]['tcp'][8009]['state']
    #print(status)
    return status


def check1(val1):   #判断tomcat版本
    #print(val1)
    if val1[0] == "6":    #tomcat6
        return True
    if val1[0] == "7":    #tomcat7
        if "0" <= val1[2] <= "100":
            return True
    if val1[0] == "8":    #tomcat8
        if "0" <= val1[1] <= "4":
            return True
        if val1[1] == "5" and "0" <= val1[2] <= "51":
            return True
    if val1[0] == "9":    #tomcat9
        if val1[1] == "0" and "0" <= val1[2] <= "31":
            return True


def check2(val1, val2):
    if val1 == "True" and val2 == "open":
        print("Vulnerable is exist!")
    elif val1 == "True" and val2 == "closed":
        print("Port is down,not vulnerable!")
    else:
        print("Vulnerable is not exist!")


if __name__ == "__main__":
    ip = address()
    url = geturl(ip)
    ver = version(url)
    status = port(ip)
    result = check1(ver)
    if result == True:
        result2 = "True"
    #print(result2)
    check2(result2, status)